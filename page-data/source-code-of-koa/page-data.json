{"componentChunkName":"component---src-templates-blog-post-js","path":"/source-code-of-koa/","result":{"data":{"site":{"siteMetadata":{"title":"Colgin's Blog"}},"markdownRemark":{"id":"38ec0cec-3f05-55b7-a255-4ed3627c6e54","excerpt":"Koa是Node应用广泛的后端框架，它的“洋葱”模型被人津津乐道，Koa源码实现也非常简练，那就一起来看下Koa的源码吧。 工程化 npm prune会移除无关的包，所谓无关指的是没有在父包的依赖关系列表中列出的包。参考npm prune wrk是一个http测试工具 意思就是看看30s，用12个线程，开40…","html":"<p>Koa是Node应用广泛的后端框架，它的“洋葱”模型被人津津乐道，Koa源码实现也非常简练，那就一起来看下Koa的源码吧。</p>\n<!--more-->\n<h2>工程化</h2>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"># <span class=\"token punctuation\">.</span>editorconfig\n# editorconfig<span class=\"token punctuation\">.</span>org\nroot <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token operator\">*</span><span class=\"token punctuation\">]</span>\nindent_style <span class=\"token operator\">=</span> space\nindent_size <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\nend_of_line <span class=\"token operator\">=</span> lf\ncharset <span class=\"token operator\">=</span> utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>\ntrim_trailing_whitespace <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\ninsert_final_newline <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n\n<span class=\"token punctuation\">[</span><span class=\"token operator\">*</span><span class=\"token punctuation\">.</span>md<span class=\"token punctuation\">]</span>\ntrim_trailing_whitespace <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n\n<span class=\"token punctuation\">[</span>Makefile<span class=\"token punctuation\">]</span>\nindent_style <span class=\"token operator\">=</span> tab</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># .travis.yml</span>\n<span class=\"token key atrule\">language</span><span class=\"token punctuation\">:</span> node_js\n<span class=\"token key atrule\">node_js</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token number\">8</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token number\">10</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token number\">12</span>\n<span class=\"token key atrule\">cache</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">directories</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> wrk/bin\n    <span class=\"token punctuation\">-</span> node_modules\n<span class=\"token key atrule\">before_script</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> npm prune\n  <span class=\"token punctuation\">-</span> <span class=\"token string\">\"[ ! -f wrk/bin/wrk ] &amp;&amp; rm -rf wrk &amp;&amp; git clone https://github.com/wg/wrk.git &amp;&amp; make -C wrk &amp;&amp; mkdir wrk/bin &amp;&amp; mv wrk/wrk wrk/bin || true\"</span>\n  <span class=\"token punctuation\">-</span> export PATH=$PATH<span class=\"token punctuation\">:</span>$PWD/wrk/bin/\n<span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> npm run lint\n  <span class=\"token punctuation\">-</span> npm run test<span class=\"token punctuation\">-</span>cov\n  <span class=\"token punctuation\">-</span> npm run bench\n<span class=\"token key atrule\">after_script</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># only upload the coverage.json file</span>\n  <span class=\"token punctuation\">-</span> bash &lt;(curl <span class=\"token punctuation\">-</span>s https<span class=\"token punctuation\">:</span>//codecov.io/bash) <span class=\"token punctuation\">-</span>f coverage/coverage<span class=\"token punctuation\">-</span>final.json</code></pre></div>\n<p>npm prune会移除无关的包，所谓无关指的是没有在父包的依赖关系列表中列出的包。参考<a href=\"https://www.npmjs.cn/cli/prune/\">npm prune</a></p>\n<p><a href=\"https://github.com/wg/wrk\">wrk</a>是一个http测试工具</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">wrk -t12 -c400 -d30s http://127.0.0.1:8080/index.html</code></pre></div>\n<p>意思就是看看30s，用12个线程，开400个http连接能处理多少个http请求。</p>\n<p>再看<code class=\"language-text\">package.json</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"name\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"koa\"</span>,\n  <span class=\"token string\">\"version\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"2.12.0\"</span>,\n  <span class=\"token string\">\"description\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Koa web app framework\"</span>,\n  <span class=\"token string\">\"main\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"lib/application.js\"</span>,\n  <span class=\"token string\">\"scripts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"test\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"egg-bin test test\"</span>,\n    <span class=\"token string\">\"test-cov\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"egg-bin cov test\"</span>,\n    <span class=\"token string\">\"lint\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"eslint benchmarks lib test\"</span>,\n    <span class=\"token string\">\"bench\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"make -C benchmarks\"</span>,\n    <span class=\"token string\">\"authors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"git log --format='%aN &lt;%aE>' | sort -u > AUTHORS\"</span>\n  <span class=\"token punctuation\">}</span>,\n  <span class=\"token string\">\"repository\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"koajs/koa\"</span>,\n  <span class=\"token string\">\"keywords\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"web\"</span>,\n    <span class=\"token string\">\"app\"</span>,\n    <span class=\"token string\">\"http\"</span>,\n    <span class=\"token string\">\"application\"</span>,\n    <span class=\"token string\">\"framework\"</span>,\n    <span class=\"token string\">\"middleware\"</span>,\n    <span class=\"token string\">\"rack\"</span>\n  <span class=\"token punctuation\">]</span>,\n  <span class=\"token string\">\"license\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"MIT\"</span>,\n  <span class=\"token string\">\"dependencies\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"accepts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.3.5\"</span>,\n    <span class=\"token string\">\"cache-content-type\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.0.0\"</span>,\n    <span class=\"token string\">\"content-disposition\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"~0.5.2\"</span>,\n    <span class=\"token string\">\"content-type\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.0.4\"</span>,\n    <span class=\"token string\">\"cookies\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"~0.8.0\"</span>,\n    <span class=\"token string\">\"debug\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"~3.1.0\"</span>,\n    <span class=\"token string\">\"delegates\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.0.0\"</span>,\n    <span class=\"token string\">\"depd\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.1.2\"</span>,\n    <span class=\"token string\">\"destroy\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.0.4\"</span>,\n    <span class=\"token string\">\"encodeurl\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.0.2\"</span>,\n    <span class=\"token string\">\"escape-html\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.0.3\"</span>,\n    <span class=\"token string\">\"fresh\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"~0.5.2\"</span>,\n    <span class=\"token string\">\"http-assert\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.3.0\"</span>,\n    <span class=\"token string\">\"http-errors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.6.3\"</span>,\n    <span class=\"token string\">\"is-generator-function\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.0.7\"</span>,\n    <span class=\"token string\">\"koa-compose\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^4.1.0\"</span>,\n    <span class=\"token string\">\"koa-convert\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.2.0\"</span>,\n    <span class=\"token string\">\"on-finished\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^2.3.0\"</span>,\n    <span class=\"token string\">\"only\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"~0.0.2\"</span>,\n    <span class=\"token string\">\"parseurl\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.3.2\"</span>,\n    <span class=\"token string\">\"statuses\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.5.0\"</span>,\n    <span class=\"token string\">\"type-is\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.6.16\"</span>,\n    <span class=\"token string\">\"vary\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^1.1.2\"</span>\n  <span class=\"token punctuation\">}</span>,\n  <span class=\"token string\">\"devDependencies\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"egg-bin\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^4.13.0\"</span>,\n    <span class=\"token string\">\"eslint\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^6.5.1\"</span>,\n    <span class=\"token string\">\"eslint-config-koa\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^2.0.0\"</span>,\n    <span class=\"token string\">\"eslint-config-standard\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^14.1.0\"</span>,\n    <span class=\"token string\">\"eslint-plugin-import\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^2.18.2\"</span>,\n    <span class=\"token string\">\"eslint-plugin-node\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^10.0.0\"</span>,\n    <span class=\"token string\">\"eslint-plugin-promise\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^4.2.1\"</span>,\n    <span class=\"token string\">\"eslint-plugin-standard\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^4.0.1\"</span>,\n    <span class=\"token string\">\"mm\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^2.5.0\"</span>,\n    <span class=\"token string\">\"supertest\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^3.1.0\"</span>\n  <span class=\"token punctuation\">}</span>,\n  <span class=\"token string\">\"engines\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"node\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"^4.8.4 || ^6.10.1 || ^7.10.1 || >= 8.1.4\"</span>\n  <span class=\"token punctuation\">}</span>,\n  <span class=\"token string\">\"files\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"lib\"</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里需要留意的是有一个<code class=\"language-text\">authors</code>命令, <code class=\"language-text\">git log --format='%aN &lt;%aE>' | sort -u > AUTHORS</code></p>\n<p>这条命令是把git 提交记录的姓名和邮件排序输出到AUTHORS文件。</p>\n<h2>核心代码</h2>\n<h3>入口</h3>\n<p>入口是<a href=\"https://github.com/koajs/koa/blob/master/lib/application.js\">application.js</a></p>\n<p>先看构造函数</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Application</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Emitter</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/**\n   * Initialize a new `Application`.\n   *\n   * @api public\n   */</span>\n\n  <span class=\"token comment\">/**\n    *\n    * @param {object} [options] Application options\n    * @param {string} [options.env='development'] Environment\n    * @param {string[]} [options.keys] Signed cookie keys\n    * @param {boolean} [options.proxy] Trust proxy headers\n    * @param {number} [options.subdomainOffset] Subdomain offset\n    * @param {boolean} [options.proxyIpHeader] proxy ip header, default to X-Forwarded-For\n    * @param {boolean} [options.maxIpsCount] max ips read from proxy ip header, default to 0 (means infinity)\n    *\n    */</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    options <span class=\"token operator\">=</span> options <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>proxy <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>proxy <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>subdomainOffset <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>subdomainOffset <span class=\"token operator\">||</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>proxyIpHeader <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>proxyIpHeader <span class=\"token operator\">||</span> <span class=\"token string\">'X-Forwarded-For'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>maxIpsCount <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>maxIpsCount <span class=\"token operator\">||</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>env <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>env <span class=\"token operator\">||</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">||</span> <span class=\"token string\">'development'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>keys <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>middleware <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>request <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>response <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>util<span class=\"token punctuation\">.</span>inspect<span class=\"token punctuation\">.</span>custom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span>util<span class=\"token punctuation\">.</span>inspect<span class=\"token punctuation\">.</span>custom<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>inspect<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>就是一些初始化流程，把options的一些选项挂在到this上。这里有一个要留意的是代理相关的配置。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">'debug'</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里http.createServer接收的是一个<code class=\"language-text\">function(req, res) {}</code>函数，这里调用了calllback生成这样一个函数。这样的设计使得可以将callback生成的处理器放到任何能够接受监听器函数中用于启动一个服务，比如说http.createServer或者express。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> fn <span class=\"token operator\">=</span> <span class=\"token function\">compose</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>middleware<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">listenerCount</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error)) this.on('</span>error'<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onerror<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleRequest</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">createContext</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里主要就是构造出一个上下文对象，然后在handleRequest里去处理这个请求。</p>\n<p>先看下创建上下文的函数<code class=\"language-text\">createContext</code>吧</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">createContext</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> context <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> request <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>request <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>response <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span>app <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>app <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>app <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span>req <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>req <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>req <span class=\"token operator\">=</span> req<span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span>res <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>res <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>res <span class=\"token operator\">=</span> res<span class=\"token punctuation\">;</span>\n    request<span class=\"token punctuation\">.</span>ctx <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>ctx <span class=\"token operator\">=</span> context<span class=\"token punctuation\">;</span>\n    request<span class=\"token punctuation\">.</span>response <span class=\"token operator\">=</span> response<span class=\"token punctuation\">;</span>\n    response<span class=\"token punctuation\">.</span>request <span class=\"token operator\">=</span> request<span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span>originalUrl <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>originalUrl <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">;</span>\n    context<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> context<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>前面构造函数中对<code class=\"language-text\">this.context</code>, <code class=\"language-text\">this.request</code>, <code class=\"language-text\">this.response</code>进行了初始化</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>request <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>response <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">createContext</code>做的就是给context变量里的req,res,ctx进行赋值，吧res和req不仅挂到了context上，还挂到了<code class=\"language-text\">contex.request</code>, <code class=\"language-text\">context.response</code>上。</p>\n<p>接下来看一下koa为人津津乐道的插件机制。在<a href=\"https://www.github.com/koajs/koa\">koa github</a>主页上有这么一段话介绍koa</p>\n<ul>\n<li>Expressive HTTP middleware framework for node.js to make web applications and APIs more enjoyable to write. Koa’s middleware stack flows in a stack-like manner, allowing you to perform actions downstream then filter and manipulate the response upstream</li>\n</ul>\n<p>koa提供了一个web框架的核心部分，不包含路由处理，静态文件处理（这些都是通过中间件来实现），我们经常会把这种叫做洋葱模型。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 478px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/62c210d99d9af8aaa2e1eccf88f9a426/50978/core-of-koa.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.13924050632912%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADFUlEQVQ4y4VU20uTYRzev1EQBd0U9CcUdF1UdFOWiAeKLryTJhNBWrSau6q8sKHRMpmhsBNuU+YBNvG0DY+bZzc3z6dN8bzpE89PvrVZ0Qu/8b17fzzf83ue5/1UZ2dnYHGlUilEo1GMjY2hubkZRqMRVVVV0Gq1cLvd0pPd/7eluvjH1NQUrFYrXC4XJicnMTQ0BJ1Oh9LSUqytrUnP6enpvwGXlpZweHiIk5MTYbi/v4+Dg4OcpoWFBWg0Gvj9/gwgS2GbXSqn0wm73S6Menp6wP329nYOIPcVFRXwer3/Z8gfstvZ2RGGrGygWCwmepIh5eA6OjpCKBQSCTY2NrC+vi61uroKlSLw1/p67O3tyfPExAQcDocYwSLz7u5uDAwMyDkl6uvrk/+Vybj3eDxQpdNpaTJ80CPgD8Dc1ISGhgaMjIwII2rMN8/OzqK1tfUPfTnd8fHx75EVQJvFipLiYng6PFhZWcHMzIyMRAAyX15eFhb9/f05gJ8/fkI0EpFnYmUAaUzek6dYXFxEJBIRVru7u0gmk+I8taTbCku+rKSwCK9evDw3Kn3uukpx7UdjI/LznuHWjZsIBgJIpdPY3NyUkbg4Fl8eDAbx9o0WVy5dxvWr1xCPxXKcF0CORN16e3tRWFCAB/fuw+10SZPP64XDbsdPcxPev9Oh4Hk+Hj98hLu378iZcsMUczOxMZlMiMfjSCSTCIfCYhCvYflrNUqKiqApL8f3byYYvxjFccpwccnICtWWlhb4fD4BoT48pJ6dnZ0IBALwdHTIOYPf1tYmrKjz1taWZFBxOgNIV+vq6jIfBzYRkHeZug0ODkqYa2pq0NXVhfn5eckro8X+ubk5AVVlC0oH29vbBTwcDktUhoeHhSE/FAy7Xq8XxwnAbI6OjkpW6YPERhGTTTabDWq1WkZisAlCMGpmNptRXV2N8fFxGZWTEJB7Mmd2ZWQFkFrU1tairKwMlZWVMBgMoiuLY1osFsknpSBzTjE9PS2TUBbuhaHijrIYZorPO6p8eQjABCisqB/BqB9HTyQSmSv5C6r7860EfxLZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"core of koa\"\n        title=\"core of koa\"\n        src=\"/static/62c210d99d9af8aaa2e1eccf88f9a426/50978/core-of-koa.png\"\n        srcset=\"/static/62c210d99d9af8aaa2e1eccf88f9a426/c26ae/core-of-koa.png 158w,\n/static/62c210d99d9af8aaa2e1eccf88f9a426/6bdcf/core-of-koa.png 315w,\n/static/62c210d99d9af8aaa2e1eccf88f9a426/50978/core-of-koa.png 478w\"\n        sizes=\"(max-width: 478px) 100vw, 478px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>实际使用中使用use来给koa应用注册中间件，中间件按照注册顺序按序调用，前面的中间件可以调用next()来控制下一个中间件的执行。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> Koa <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'koa'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Koa</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// logger</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> rt <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'X-Response-Time'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>ctx<span class=\"token punctuation\">.</span>method<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>ctx<span class=\"token punctuation\">.</span>url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> - </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>rt<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// x-response-time</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> start <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> ms <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start<span class=\"token punctuation\">;</span>\n  ctx<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'X-Response-Time'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>ms<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">ms</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// response</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token parameter\">ctx</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token string\">'Hello World'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>通过中间件可以做到调用下游，控制流回上游</p>\n<p>那这个是怎么实现的呢？先来看use的实现</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> fn <span class=\"token operator\">!==</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'middleware must be a function!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isGeneratorFunction</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">deprecate</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Support for generators will be removed in v3. '</span> <span class=\"token operator\">+</span>\n                <span class=\"token string\">'See the documentation for examples of how to convert old middleware '</span> <span class=\"token operator\">+</span>\n                <span class=\"token string\">'https://github.com/koajs/koa/blob/master/docs/migration.md'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      fn <span class=\"token operator\">=</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">'use %s'</span><span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">.</span>_name <span class=\"token operator\">||</span> fn<span class=\"token punctuation\">.</span>name <span class=\"token operator\">||</span> <span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>middleware<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>use函数实现非常简单，就是把注册进来中间件函数<code class=\"language-text\">(context, next) ⇒ {}</code>  存放到实例的middleware里面。那么这个middleware是怎么起作用的呢？</p>\n<p>细心的你可能在之前的<code class=\"language-text\">callback</code> 函数中发现有这样一行</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> fn <span class=\"token operator\">=</span> <span class=\"token function\">compose</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>middleware<span class=\"token punctuation\">)</span></code></pre></div>\n<p>这行代码就是实现中间件的精髓。compose将所有的中间件组合成一个函数。</p>\n<p>先不看官方的实现，我们可以自己实现一个这样的compose函数</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">compose</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">middlewares</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">i</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> fn <span class=\"token operator\">=</span> middlewares<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n\n    <span class=\"token comment\">// 最后一个中间件调用next不能报错</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看到，compose生成了一个新的函数，在这个函数中我们把ctx传入进去，所有的中间件都会执行，执行的顺序通过给中间件函数传递的第二个参数来控制，也就是说把在第n+1个中间件函数的执行权交给第n个中间件函数。</p>\n<p>koa实际是使用了<a href=\"https://github.com/koajs/compose#readme\">koa/compose</a>。这里一并把代码贴出来</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> compose\n\n<span class=\"token comment\">/**\n * Compose `middleware` returning\n * a fully valid middleware comprised\n * of all those which are passed.\n *\n * @param {Array} middleware\n * @return {Function}\n * @api public\n */</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">compose</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">middleware</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>middleware<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Middleware stack must be an array!'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> fn <span class=\"token keyword\">of</span> middleware<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> fn <span class=\"token operator\">!==</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Middleware must be composed of functions!'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * @param {Object} context\n   * @return {Promise}\n   * @api public\n   */</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">context<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// last called middleware #</span>\n    <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">dispatch</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">i</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;=</span> index<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'next() called multiple times'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      index <span class=\"token operator\">=</span> i\n      <span class=\"token keyword\">let</span> fn <span class=\"token operator\">=</span> middleware<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">===</span> middleware<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> fn <span class=\"token operator\">=</span> next\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fn<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>相对于简陋版本的compose来说，这里的compose考虑了不能在一个中间件中调用多次next，还处理了最后一个中间件不调用next的情况。</p>\n<p>Koa构造函数还有两个函数，toJSON, inspect，这俩函数就是返回指定的几个字段。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">/**\n   * Return JSON representation.\n   * We only bother showing settings.\n   *\n   * @return {Object}\n   * @api public\n   */</span>\n\n  <span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">only</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">'subdomainOffset'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'proxy'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'env'</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * Inspect implementation.\n   *\n   * @return {Object}\n   * @api public\n   */</span>\n\n  <span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>再看下处理请求的部分，处理请求包括错误处理，数据响应。这里有一个onFinished(res, onerror)是在响应结束或者关闭或者错误的时候执行一下onerror方法。<a href=\"https://github.com/jshttp/on-finished\">on-finished</a></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> fnMiddleware</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>res\n\tres<span class=\"token punctuation\">.</span>statusCode <span class=\"token operator\">=</span> <span class=\"token number\">404</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">onerror</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleResponse</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">respond</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token function\">onFinished</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> onerror<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token function\">fnMiddleware</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>handleResponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>onerror<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">respond</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token comment\">// allow bypassing koa</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span> <span class=\"token operator\">===</span> ctx<span class=\"token punctuation\">.</span>respond<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>ctx<span class=\"token punctuation\">.</span>writable<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\n\t<span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>res\n\t<span class=\"token keyword\">let</span> body <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>body\n\t<span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// statuses.empty(code) returns true if a status code expects an empty body</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>statuses<span class=\"token punctuation\">.</span>empty<span class=\"token punctuation\">[</span>code<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">// strip headers</span>\n\t\tctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\t\t<span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'HEAD'</span> <span class=\"token operator\">===</span> ctx<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>res<span class=\"token punctuation\">.</span>headersSent <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>ctx<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Length'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> length <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> ctx\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Number<span class=\"token punctuation\">.</span><span class=\"token function\">isInteger</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> ctx<span class=\"token punctuation\">.</span>length <span class=\"token operator\">=</span> length\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// status body</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token operator\">===</span> body<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>reponse<span class=\"token punctuation\">.</span>_expliciNullBody<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tctx<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">)</span>\n\t\t\tctx<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Transfer-Encoding'</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>httpVersionMajaor <span class=\"token operator\">>=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tbody <span class=\"token operator\">=</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\t\tbody <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>message <span class=\"token operator\">||</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>res<span class=\"token punctuation\">.</span>headersSend<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\tctx<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">'text'</span>\n\t\t\tctx<span class=\"token punctuation\">.</span>length <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">byteLength</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// responses</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">isBuffer</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'string'</span> <span class=\"token operator\">===</span> <span class=\"token keyword\">typeof</span> body<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>body <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Stream</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> body<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// body: json</span>\n\tbody <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>res<span class=\"token punctuation\">.</span>headersSent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tctx<span class=\"token punctuation\">.</span>length <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">byteLength</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tres<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里处理了不同类型的body，这里可以看到如果<code class=\"language-text\">res.headersSent</code>为false的话，会写一些header。</p>\n<p>context, request, response</p>\n<h3>context</h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">COOKIES</span> <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">'context#cookies'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> proto <span class=\"token operator\">=</span> module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token operator\">===</span> proto<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n\t<span class=\"token comment\">// 返回对象的所有json表示</span>\n\t<span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token literal-property property\">request</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token literal-property property\">response</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token literal-property property\">app</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span><span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token literal-property property\">originalUrl</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>originalUrl<span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token literal-property property\">req</span><span class=\"token operator\">:</span> <span class=\"token string\">'&lt;original node req>'</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token literal-property property\">res</span><span class=\"token operator\">:</span> <span class=\"token string\">'&lt;original node res>'</span><span class=\"token punctuation\">,</span>\n\t\t\t<span class=\"token literal-property property\">socket</span><span class=\"token operator\">:</span> <span class=\"token string\">'&lt;original node socket>'</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n\t<span class=\"token comment\">// assertion</span>\n\t<span class=\"token literal-property property\">assert</span><span class=\"token operator\">:</span> httpAssert<span class=\"token punctuation\">,</span>\n\n\t<span class=\"token comment\">// throw error</span>\n\t<span class=\"token keyword\">throw</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">throw</span> <span class=\"token function\">createError</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n\t<span class=\"token comment\">// default error handling</span>\n\t<span class=\"token function\">onerror</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">//</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n\t<span class=\"token comment\">// cookies</span>\n\t<span class=\"token keyword\">get</span> <span class=\"token function\">cookies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span><span class=\"token constant\">COOKIES</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span><span class=\"token constant\">COOKIES</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cookie</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>res<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token literal-property property\">keys</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">,</span>\n\t\t\t\t<span class=\"token literal-property property\">secure</span><span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>secure\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n\t<span class=\"token keyword\">set</span> <span class=\"token function\">cookies</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_cookies</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span><span class=\"token constant\">COOKIES</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> _cookies\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Response delegation.\n */</span>\n\n<span class=\"token function\">delegate</span><span class=\"token punctuation\">(</span>proto<span class=\"token punctuation\">,</span> <span class=\"token string\">'response'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'attachment'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'redirect'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'remove'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'vary'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'has'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'set'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'append'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'flushHeaders'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'status'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'body'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'length'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'type'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'lastModified'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'etag'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'headerSent'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'writable'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * Request delegation.\n */</span>\n\n<span class=\"token function\">delegate</span><span class=\"token punctuation\">(</span>proto<span class=\"token punctuation\">,</span> <span class=\"token string\">'request'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'acceptsLanguages'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'acceptsEncodings'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'acceptsCharsets'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'accepts'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'get'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token string\">'is'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'querystring'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'idempotent'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'socket'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'search'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'method'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'query'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'url'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token string\">'accept'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'origin'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'href'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'subdomains'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'protocol'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'host'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hostname'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'URL'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'header'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'headers'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'secure'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'stale'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fresh'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ips'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ip'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>context里写了很多setter，getter,并且使用<a href=\"https://github.com/tj/node-delegates\">delegate</a>把<strong>request</strong>，<strong>response</strong>的东西挂到委托到<strong>context</strong>上。</p>\n<h3>request</h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token constant\">IP</span> <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">'context#ip'</span><span class=\"token punctuation\">)</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">get</span> <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>headers\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">set</span> <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>headers <span class=\"token operator\">=</span> val\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">get</span> <span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>url\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">set</span> <span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>url <span class=\"token operator\">=</span> val\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">get</span> <span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>method\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">set</span> <span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">.</span>method <span class=\"token operator\">=</span> val\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">get</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">const</span> str <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>querystring<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">const</span> c <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_querycache <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_querycache <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> c<span class=\"token punctuation\">[</span>str<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">[</span>str<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> qs<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">set</span> <span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>querystring <span class=\"token operator\">=</span> q<span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">get</span> <span class=\"token function\">querystring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token string\">''</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>query <span class=\"token operator\">||</span> <span class=\"token string\">''</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">set</span> <span class=\"token function\">querystring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span>search <span class=\"token operator\">===</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">?</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>str<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n\t\turl<span class=\"token punctuation\">.</span>search <span class=\"token operator\">=</span> str\n\t\turl<span class=\"token punctuation\">.</span>patch <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>url <span class=\"token operator\">=</span> <span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">get</span> <span class=\"token function\">socket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>socket\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token keyword\">get</span> <span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">const</span> len <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Length'</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>len <span class=\"token operator\">===</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token operator\">~</span><span class=\"token operator\">~</span>len\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token comment\">/**\n   * Return request's remote address\n   * When `app.proxy` is `true`, parse\n   * the \"X-Forwarded-For\" ip address list and return the first one\n   *\n   * @return {String}\n   * @api public\n   */</span>\n\n  <span class=\"token keyword\">get</span> <span class=\"token function\">ip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span><span class=\"token constant\">IP</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span><span class=\"token constant\">IP</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ips<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>socket<span class=\"token punctuation\">.</span>remoteAddress <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span><span class=\"token constant\">IP</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token keyword\">set</span> <span class=\"token function\">ip</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_ip</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span><span class=\"token constant\">IP</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> _ip<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token function\">get</span><span class=\"token punctuation\">(</span>field<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> req <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>field <span class=\"token operator\">=</span> field<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'referer'</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">case</span> <span class=\"token string\">'referrer'</span><span class=\"token operator\">:</span>\n        <span class=\"token keyword\">return</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>referrer <span class=\"token operator\">||</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>referer <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n        <span class=\"token keyword\">return</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span>field<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token comment\">/**\n   * Return JSON representation.\n   *\n   * @return {Object}\n   * @api public\n   */</span>\n\n  <span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">only</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">'method'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'url'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'header'</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看到这里也都是一些setter，getter，还有一些封装的方法比如get。</p>\n<p>不过从代码中可以学习到一些编码技巧。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> c <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_querycache <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_querycache <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 存只避免多次访问</span>\n<span class=\"token keyword\">return</span> <span class=\"token operator\">~</span><span class=\"token operator\">~</span>len <span class=\"token comment\">// 位运算，这里相当于parseInt</span></code></pre></div>\n<p>位运算参考文章 <a href=\"https://juejin.im/post/5a98ea2f6fb9a028bb186f34\">位运算符在JS中的妙用</a></p>\n<p>上面代码还有一个比较意思的是，cookies和ip的访问都是用了Symbol。原因<a href=\"https://github.com/koajs/koa/pull/1216/commits/864da936d7005b4ef54e6c15b0bbac628472e3eb\">参考</a></p>\n<h3>response</h3>\n<p>与request 类似，不再贴代码。</p>\n<h2>测试</h2>\n<p>在package.json里script中</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token string-property property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string-property property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"egg-bin test test\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"test-cov\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"egg-bin cov test\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"lint\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eslint benchmarks lib test\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"bench\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"make -C benchmarks\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string-property property\">\"authors\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"git log --format='%aN &lt;%aE>' | sort -u > AUTHORS\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>可以看到这里功能测试使用的是egg-bin（mocha）</p>\n<h3>基准测试</h3>\n<p><code class=\"language-text\">make -C benchmarks</code> ，首先可以了解一下<a href=\"http://www.ruanyifeng.com/blog/2015/02/make.html\">make</a>。-C是改变Makefile的读取目录，这里意思就是去benchmark目录下找Makefile文件。</p>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre class=\"language-makefile\"><code class=\"language-makefile\">// benchmark/Makefile\n<span class=\"token target symbol\">all</span><span class=\"token punctuation\">:</span> middleware\n\n<span class=\"token target symbol\">middleware</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token operator\">@</span>./run 1 false <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 5 false <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 10 false <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 15 false <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 20 false <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 30 false <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 50 false <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 100 false <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 1 true <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 5 true <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 10 true <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 15 true <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 20 true <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 30 true <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 50 true <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>./run 100 true <span class=\"token variable\">$@</span>\n\t<span class=\"token operator\">@</span>echo\n\n<span class=\"token builtin-target builtin\">.PHONY</span><span class=\"token punctuation\">:</span> all middleware</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre class=\"language-makefile\"><code class=\"language-makefile\">// benchmark/middleware.js\n<span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span>\n\nconst Koa <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconst app <span class=\"token operator\">=</span> new Koa<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n// number of middleware\n\nlet n <span class=\"token operator\">=</span> parseInt<span class=\"token punctuation\">(</span>process.env.MW <span class=\"token operator\">|</span><span class=\"token operator\">|</span> <span class=\"token string\">'1'</span>, 10<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconst useAsync <span class=\"token operator\">=</span> process.env.USE_ASYNC <span class=\"token operator\">=</span><span class=\"token operator\">=</span><span class=\"token operator\">=</span> <span class=\"token string\">'true'</span><span class=\"token punctuation\">;</span>\n\nconsole.log<span class=\"token punctuation\">(</span>`  <span class=\"token variable\">$</span><span class=\"token punctuation\">{</span>n<span class=\"token punctuation\">}</span><span class=\"token variable\">$</span><span class=\"token punctuation\">{</span>useAsync ? <span class=\"token string\">' async'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">}</span> middleware`<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nwhile <span class=\"token punctuation\">(</span>n--<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  if <span class=\"token punctuation\">(</span>useAsync<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    app.use<span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">(</span>ctx, next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>> next<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    app.use<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ctx, next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>> next<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\nconst body <span class=\"token operator\">=</span> Buffer.from<span class=\"token punctuation\">(</span><span class=\"token string\">'Hello World'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nif <span class=\"token punctuation\">(</span>useAsync<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  app.use<span class=\"token punctuation\">(</span>async<span class=\"token punctuation\">(</span>ctx, next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>> <span class=\"token punctuation\">{</span> await next<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ctx.body <span class=\"token operator\">=</span> body<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  app.use<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ctx, next<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>> next<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.then<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>> ctx.body <span class=\"token operator\">=</span> body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\napp.listen<span class=\"token punctuation\">(</span>3333<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>功能测试</h3>\n<p>测试代码就不看了，有兴趣自己去github上看看。</p>","frontmatter":{"title":"koa源码解析","date":"May 23, 2020","description":"简单强大的koa源码，非常值得一读的源码"}},"previous":{"fields":{"slug":"/graceful-restart-or-stop/"},"frontmatter":{"title":"如何优雅关机重启"}},"next":{"fields":{"slug":"/main-field-in-package-json/"},"frontmatter":{"title":"package.json里的main字段"}}},"pageContext":{"id":"38ec0cec-3f05-55b7-a255-4ed3627c6e54","previousPostId":"f6ff3f26-2cbf-545c-9895-9b5479c33605","nextPostId":"298a27f4-c474-58ed-88e2-c592390ae11c"}},"staticQueryHashes":["2841359383","965855181"]}