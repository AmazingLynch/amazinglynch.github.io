{"componentChunkName":"component---src-templates-blog-post-js","path":"/vue-bundle/","result":{"data":{"site":{"siteMetadata":{"title":"Colgin's Blog"}},"markdownRemark":{"id":"cda5a50a-b9f7-559e-a9d0-ab2c50c57d36","excerpt":"随着前端工程变得越来越复杂，各种构建工具也层出不穷，原生esm 的支持，同构应用需要在node 环境下运行代码，本文将以vue 框架入手，探讨库作者应该如何给不同场景提供不同的文件。 首先可以知道vue 是一个monorepo的架构，各个子包都使用同一份rollup 配置文件进行打包。配置文件可以查看vuejs…","html":"<p>随着前端工程变得越来越复杂，各种构建工具也层出不穷，原生esm 的支持，同构应用需要在node 环境下运行代码，本文将以vue 框架入手，探讨库作者应该如何给不同场景提供不同的文件。<!-- more --></p>\n<p>首先可以知道vue 是一个monorepo的架构，各个子包都使用同一份rollup 配置文件进行打包。配置文件可以查看<a href=\"https://github.com/vuejs/core/blob/main/rollup.config.js\">vuejs/core rollup.js</a>。</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> outputConfigs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string-property property\">'esm-bundler'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    file<span class=\"token operator\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">dist/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.esm-bundler.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    format<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">es</span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">'esm-browser'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    file<span class=\"token operator\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">dist/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.esm-browser.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    format<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">es</span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  cjs<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    file<span class=\"token operator\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">dist/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.cjs.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    format<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">cjs</span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  global<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    file<span class=\"token operator\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">dist/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.global.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    format<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">iife</span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// runtime-only builds, for main \"vue\" package only</span>\n  <span class=\"token string-property property\">'esm-bundler-runtime'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    file<span class=\"token operator\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">dist/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.runtime.esm-bundler.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    format<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">es</span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">'esm-browser-runtime'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    file<span class=\"token operator\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">dist/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.runtime.esm-browser.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    format<span class=\"token operator\">:</span> <span class=\"token string\">'es'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">'global-runtime'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    file<span class=\"token operator\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">dist/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>name<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.runtime.global.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    format<span class=\"token operator\">:</span> <span class=\"token string\">'iife'</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在这里，name 就是包的名字。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> isProductionBuild <span class=\"token operator\">=</span>\n    process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span>__DEV__ <span class=\"token operator\">===</span> <span class=\"token string\">'false'</span> <span class=\"token operator\">||</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.prod\\.js$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> isBundlerESMBuild <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">esm-bundler</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> isBrowserESMBuild <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">esm-browser</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> isServerRenderer <span class=\"token operator\">=</span> name <span class=\"token operator\">===</span> <span class=\"token string\">'server-renderer'</span>\n<span class=\"token keyword\">const</span> isNodeBuild <span class=\"token operator\">=</span> format <span class=\"token operator\">===</span> <span class=\"token string\">'cjs'</span>\n<span class=\"token keyword\">const</span> isGlobalBuild <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">global</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> isCompatPackage <span class=\"token operator\">=</span> pkg<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'@vue/compat'</span>\n<span class=\"token keyword\">const</span> isCompatBuild <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>packageOptions<span class=\"token punctuation\">.</span>compat\n\n<span class=\"token keyword\">const</span> replacePlugin <span class=\"token operator\">=</span> <span class=\"token function\">createReplacePlugin</span><span class=\"token punctuation\">(</span>\n\tisProductionBuild<span class=\"token punctuation\">,</span>\n\tisBundlerESMBuild<span class=\"token punctuation\">,</span>\n\tisBrowserESMBuild<span class=\"token punctuation\">,</span>\n\t<span class=\"token comment\">// isBrowserBuild?</span>\n\t<span class=\"token punctuation\">(</span>isGlobalBuild <span class=\"token operator\">||</span> isBrowserESMBuild <span class=\"token operator\">||</span> isBundlerESMBuild<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n\t  <span class=\"token operator\">!</span>packageOptions<span class=\"token punctuation\">.</span>enableNonBrowserBranches<span class=\"token punctuation\">,</span>\n\tisGlobalBuild<span class=\"token punctuation\">,</span>\n\tisNodeBuild<span class=\"token punctuation\">,</span>\n\tisCompatBuild<span class=\"token punctuation\">,</span>\n\tisServerRenderer\n<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createReplacePlugin</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">isProduction<span class=\"token punctuation\">,</span>\n  isBundlerESMBuild<span class=\"token punctuation\">,</span>\n  isBrowserESMBuild<span class=\"token punctuation\">,</span>\n  isBrowserBuild<span class=\"token punctuation\">,</span>\n  isGlobalBuild<span class=\"token punctuation\">,</span>\n  isNodeBuild<span class=\"token punctuation\">,</span>\n  isCompatBuild<span class=\"token punctuation\">,</span>\n  isServerRenderer</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> replacements <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">__COMMIT__</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">COMMIT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">__VERSION__</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>masterVersion<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">__DEV__</span><span class=\"token operator\">:</span> isBundlerESMBuild\n      <span class=\"token operator\">?</span> <span class=\"token comment\">// preserve to be handled by bundlers</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">(process.env.NODE_ENV !== 'production')</span><span class=\"token template-punctuation string\">`</span></span>\n      <span class=\"token operator\">:</span> <span class=\"token comment\">// hard coded dev/prod builds</span>\n        <span class=\"token operator\">!</span>isProduction<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// this is only used during Vue's internal tests</span>\n    <span class=\"token literal-property property\">__TEST__</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// If the build is expected to run directly in the browser (global / esm builds)</span>\n    <span class=\"token literal-property property\">__BROWSER__</span><span class=\"token operator\">:</span> isBrowserBuild<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">__GLOBAL__</span><span class=\"token operator\">:</span> isGlobalBuild<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">__ESM_BUNDLER__</span><span class=\"token operator\">:</span> isBundlerESMBuild<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">__ESM_BROWSER__</span><span class=\"token operator\">:</span> isBrowserESMBuild<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// is targeting Node (SSR)?</span>\n    <span class=\"token literal-property property\">__NODE_JS__</span><span class=\"token operator\">:</span> isNodeBuild<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// need SSR-specific branches?</span>\n    <span class=\"token literal-property property\">__SSR__</span><span class=\"token operator\">:</span> isNodeBuild <span class=\"token operator\">||</span> isBundlerESMBuild <span class=\"token operator\">||</span> isServerRenderer<span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// for compiler-sfc browser build inlined deps</span>\n    <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>isBrowserESMBuild\n      <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string-property property\">'process.env'</span><span class=\"token operator\">:</span> <span class=\"token string\">'({})'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string-property property\">'process.platform'</span><span class=\"token operator\">:</span> <span class=\"token string\">'\"\"'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string-property property\">'process.stdout'</span><span class=\"token operator\">:</span> <span class=\"token string\">'null'</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// 2.x compat build</span>\n    <span class=\"token literal-property property\">__COMPAT__</span><span class=\"token operator\">:</span> isCompatBuild<span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// feature flags</span>\n    <span class=\"token literal-property property\">__FEATURE_SUSPENSE__</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">__FEATURE_OPTIONS_API__</span><span class=\"token operator\">:</span> isBundlerESMBuild <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">__VUE_OPTIONS_API__</span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">__FEATURE_PROD_DEVTOOLS__</span><span class=\"token operator\">:</span> isBundlerESMBuild\n      <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">__VUE_PROD_DEVTOOLS__</span><span class=\"token template-punctuation string\">`</span></span>\n      <span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>isProduction <span class=\"token operator\">&amp;&amp;</span> isBrowserBuild\n      <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string-property property\">'context.onError('</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/*#__PURE__*/ context.onError(</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n          <span class=\"token string-property property\">'emitError('</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/*#__PURE__*/ emitError(</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n          <span class=\"token string-property property\">'createCompilerError('</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/*#__PURE__*/ createCompilerError(</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n          <span class=\"token string-property property\">'createDOMCompilerError('</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/*#__PURE__*/ createDOMCompilerError(</span><span class=\"token template-punctuation string\">`</span></span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">.</span> <span class=\"token comment\">// allow inline overrides like</span>\n  <span class=\"token comment\">//__RUNTIME_COMPILE__=true yarn build runtime-core</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>replacements<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>key <span class=\"token keyword\">in</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      replacements<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// @ts-ignore</span>\n    <span class=\"token literal-property property\">values</span><span class=\"token operator\">:</span> replacements<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">preventAssignment</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看到根据 文件名可推断出很多信息，比如是否为生产环境，是否提供给 bundler 使用，是否为node 环境，然后根据这些信息，调用 在 replacePlugin 中做不同的替换。</p>\n<p>再看下 <a href=\"https://github.com/vuejs/core/blob/main/packages/vue/package.json\">vue package.json</a></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"main\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"index.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"module\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dist/vue.runtime.esm-bundler.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"types\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dist/vue.d.ts\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"unpkg\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dist/vue.global.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"jsdelivr\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dist/vue.global.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exports\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\".\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"import\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"node\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./index.mjs\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"default\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./dist/vue.runtime.esm-bundler.js\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"require\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./index.js\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"types\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./dist/vue.d.ts\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"./server-renderer\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"import\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./server-renderer/index.mjs\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"require\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./server-renderer/index.js\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"./compiler-sfc\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"import\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./compiler-sfc/index.mjs\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"require\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./compiler-sfc/index.js\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"./dist/*\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./dist/*\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"./package.json\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./package.json\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"./macros\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./macros.d.ts\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"./macros-global\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./macros-global.d.ts\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"./ref-macros\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./ref-macros.d.ts\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>exports 是 node 支持的字段，用来定义包的入口点，这种形式一般也叫 条件导出，参考<a href=\"http://nodejs.cn/api/packages.html#exports\">exports in nodes.js</a></p>\n<p>vue 的 <code class=\"language-text\">main</code> 入口指定的 <code class=\"language-text\">index.js</code> 是作为 commonjs 规范的入口文件</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'use strict'</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/vue.cjs.prod.js'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/vue.cjs.js'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>得益于commonjs 的动态特性，可以根据不同环境 使用不同的文件。为什么要这么做，可以看<a href=\"https://overreacted.io/how-does-the-development-mode-work/\">How Does the Development Mode Work</a> ， 而且<a href=\"https://npm.runkit.com/react/index.js?t=1656841506637\">react</a> 也是这么做的。打包工具 <a href=\"https://github.com/jaredpalmer/tsdx\">tsdx</a> 将这作为最佳实践打包代码。他作出的<a href=\"https://tsdx.io/optimization\">解释</a>是 通过这种方式，可以在开发模式中能够让你的库为用户提供更多的错误信息，而生产环境，这些提示代码就会被丢弃。当然，这依赖于end-user（终端用户，可以理解为使用你库的开发者）的环境变量设置，就目前而言，webpack，rollup 都是会在build 的时候将 <code class=\"language-text\">process.env.NODE_ENV</code> 设置为 ‘production’, 其他环境则为 ‘development’。</p>\n<p>对照着前面的outputConfig， createReplacePlugin的代码 以及 <a href=\"https://github.com/vuejs/core/blob/main/packages/vue/README.md\">vue readme</a> 的解释，我们可以对所有输出的文件用处做一个总结。</p>\n<table>\n<thead>\n<tr>\n<th>文件名</th>\n<th>格式</th>\n<th>用途</th>\n<th>特点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>dist/vue.esm-bundler.js</td>\n<td>esm</td>\n<td>给webpack，rollup，parcel这类打包工具使用。module字段</td>\n<td>1. 保留诸如<code class=\"language-text\">process.env.NODE_ENV</code> 这类语句，留给bundler去替换； 2. 不需要minify；3. external dependencies</td>\n</tr>\n<tr>\n<td>dist/vue.runtime.esm-bundler.js</td>\n<td>esm</td>\n<td>同上</td>\n<td>同上 但只包含运行时</td>\n</tr>\n<tr>\n<td>dist/vue.esm-browser.js</td>\n<td>esm</td>\n<td>给通过浏览器 <code class=\"language-text\">&lt;script type=\"module\"></code> 直接使用</td>\n<td>1. external dependencies； 2. <code class=\"language-text\">process.env.NODE_ENV</code> 要被替换为真正的值</td>\n</tr>\n<tr>\n<td>dist/vue.esm.runtime.esm-browser.js</td>\n<td>esm</td>\n<td>同上</td>\n<td>同上 但是 但包含vue运行时</td>\n</tr>\n<tr>\n<td>dist/vue.cjs.js</td>\n<td>cjs</td>\n<td>在 main 字段中对应的文件中开发环境使用的文件，用在node环境</td>\n<td>1. 将<code class=\"language-text\">process.env.NODE_ENV</code>替换为<code class=\"language-text\">\"development\"</code>； 2. 不minify；3. external dependencies</td>\n</tr>\n<tr>\n<td>dist/vue.cjs.prod.js</td>\n<td>cjs</td>\n<td>在 main 字段中对应的文件中生产环境使用的文件，用在node环境</td>\n<td>1. 将<code class=\"language-text\">process.env.NODE_ENV</code>替换为<code class=\"language-text\">\"production\"</code>； 2. minify；3. external dependencies</td>\n</tr>\n<tr>\n<td>dist/vue.global.js</td>\n<td>iife</td>\n<td>通过<code class=\"language-text\">&lt;script src=\"\"></code> 直接导入，暴露Vue全局变量。unpkg, jsdeliver字段</td>\n<td>1. 将 <code class=\"language-text\">process.env.NODE_ENV</code> 替换为 <code class=\"language-text\">\"development\"</code>； 2. 不minify；3. 打包所有依赖</td>\n</tr>\n<tr>\n<td>dist/vue.runtime.global.js</td>\n<td>iife</td>\n<td>同上</td>\n<td>同上，只包含运行时</td>\n</tr>\n<tr>\n<td>dist/vue.global.prod.js</td>\n<td>iife</td>\n<td>同上</td>\n<td>1. 将<code class=\"language-text\">process.env.NODE_ENV</code> 替换为 <code class=\"language-text\">\"development\"</code>；2. minify; 3. 打包所有依赖</td>\n</tr>\n<tr>\n<td>dist/vue.runtime.global.prod.js</td>\n<td>iife</td>\n<td>同上</td>\n<td>同上，只包含运行时</td>\n</tr>\n</tbody>\n</table>\n<p>可以看到各种场景下的区别在于以下几点</p>\n<ol>\n<li>是否打包依赖</li>\n<li>是否需要压缩代码</li>\n<li>是否需要处理 <code class=\"language-text\">process.env.NODE_ENV</code>语句， 或者其他类似的替换</li>\n</ol>","frontmatter":{"title":"vue如何打包分发代码","date":"July 03, 2022","description":"日益复杂的前端环境，vue是如何打包分发代码？"}},"previous":{"fields":{"slug":"/why-bundle-your-package/"},"frontmatter":{"title":"你为什么打包你的库"}},"next":null},"pageContext":{"id":"cda5a50a-b9f7-559e-a9d0-ab2c50c57d36","previousPostId":"99c9c0f7-1fa0-58cb-82f2-cc66772fc02b","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"]}